# Tekton manifests audit

This folder contains Tekton manifests used in this deployment. This document
explains which files are required, which are optional, and provides a minimal
non-CRD manifest you can apply as a clean baseline.

Summary of files (present in this folder)
- `dashboard.yaml` — Optional. UI/dashboard resources (Ingress/Service/Deployment).
- `github-secret.yaml` — Optional but often required if Triggers intercept GitHub webhooks.
- `ingress-dashboard.yaml`, `ingress-eventlistener.yaml` — Optional; only if you expose services via Ingress.
- `pipelines.yaml` — Non-CRD Tekton Pipelines resources (ServiceAccounts, Deployments, RBAC, etc.). THIS REPO FILE WAS CORRUPTED and should be replaced/validated. See `00-minimal-noncrd.yaml`.
- `pvc.yaml` — Required if Tekton Tasks/Pipelines use a PVC for workspace caching.
- `rbac.yaml` — Likely required (cluster and namespace RBAC) — check contents.
- `registry.yaml` — Optional/required depending if you create registry resources (image registry service) locally.
- `triggers-*.yaml` (`triggers-noncrd.yaml`, `triggers-clusterrole.yaml`, `triggers-sa-default.yaml`, `triggers-cert.yaml`) — Triggers non-CRD resources and RBAC; required only if you use Tekton Triggers.
- `suma-ecommerce/` — Example pipeline/tasks/triggers for the suma-ecommerce app (project-specific). Optional for Tekton core, required if you want that pipeline.

Which files are strictly required to *run Tekton controllers* on a cluster
(non-CRD side):
- A set of non-CRD resources for Tekton Pipelines (ServiceAccounts, Deployments,
  ConfigMaps, Webhooks) — `pipelines.yaml` or equivalent. If `pipelines.yaml` is
  corrupted, replace with `00-minimal-noncrd.yaml` (this folder).
- RBAC/serviceaccounts for Triggers if you plan to use them (`triggers-*.yaml`).
- PVCs (if your Pipelines/Tasks expect a PVC) — check `pvc.yaml`.

What I found in this workspace
- `pipelines.yaml` in this repo appears to have been corrupted by repeated
  edits (embedded code fences and duplicated blocks). Replace it with a clean
  copy or use `00-minimal-noncrd.yaml` as a starting point.
- The cluster you ran against has ImagePullBackOff errors. The node cannot
  pull images from quay/ghcr/gcr/docker without authentication in this
  environment. You will need one of:
  - An `imagePullSecret` (docker-registry secret) with credentials for the
    container registries used (quay/ghcr/...).
  - A local registry mirror where images are pushed and referenced.

Quick recommended sequence (order matters)
1. Ensure Tekton CRDs are installed for the version you want (CRDs are
   usually installed once via official Tekton release YAML). Example:
   `kubectl apply -f https://storage.googleapis.com/tekton-releases/pipeline/previous/v1.5.0/release.yaml` (this includes CRDs and non-CRD manifests; check official docs for exact URL matching desired version).
2. Apply non-CRD resources (ServiceAccounts, Deployments) from this folder or
   use `00-minimal-noncrd.yaml` as the base: `kubectl apply -f k8s/tekton/00-minimal-noncrd.yaml`.
3. If pods fail with ImagePullBackOff, create imagePullSecret or mirror images.
   Example to create secret (PowerShell):
   ```powershell
   kubectl create secret docker-registry quay-reg --docker-server=quay.io --docker-username=<user> --docker-password=<pass> --docker-email=<email> -n tekton-pipelines
   kubectl patch serviceaccount tekton-pipelines-controller -n tekton-pipelines -p '{"imagePullSecrets":[{"name":"quay-reg"}]}'
   kubectl rollout restart deployment/tekton-pipelines-controller -n tekton-pipelines
   ```
4. Check pods: `kubectl get pods -n tekton-pipelines -o wide` and events
   `kubectl get events -n tekton-pipelines --sort-by='.lastTimestamp' | tail -n 50`.

Files I added in this folder
- `00-minimal-noncrd.yaml` — clean minimal non-CRD Tekton manifest (namespace,
  serviceaccounts and a controller deployment). Use as a starting point if the
  `pipelines.yaml` file is corrupted.

If you want I can (choose one):
- Replace `pipelines.yaml` with a cleaned, fully expanded non-CRD manifest and
  commit the change here.
- Create imagePullSecrets in the cluster (you must provide registry credentials
  or run the `kubectl create secret` commands locally and tell me to patch
  SAs).
- Mirror images to a local registry and update manifests to point to that
  local registry.

If you want me to proceed automatically, reply with which option you prefer
and any registry credentials (or confirm you'll run `kubectl create secret ...` locally and I will patch the SAs).

---

Generated by automated audit on repository state. Review before applying to production.
